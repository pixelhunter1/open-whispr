<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Whisper Dictation</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        .glass-effect {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { ipcRenderer } = require('electron');

        // Button Component
        const Button = ({ children, onClick, disabled, variant = "default", size = "default", className = "" }) => {
            const baseClasses = "inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background";
            
            const variants = {
                default: "bg-primary text-primary-foreground hover:bg-primary/90 bg-slate-900 text-white hover:bg-slate-800",
                destructive: "bg-destructive text-destructive-foreground hover:bg-destructive/90 bg-red-500 text-white hover:bg-red-600",
                outline: "border border-input hover:bg-accent hover:text-accent-foreground border-slate-200 hover:bg-slate-100",
                secondary: "bg-secondary text-secondary-foreground hover:bg-secondary/80 bg-slate-100 text-slate-900 hover:bg-slate-200",
                ghost: "hover:bg-accent hover:text-accent-foreground hover:bg-slate-100",
                link: "underline-offset-4 hover:underline text-primary text-blue-600"
            };
            
            const sizes = {
                default: "h-10 py-2 px-4",
                sm: "h-9 px-3 rounded-md",
                lg: "h-11 px-8 rounded-md",
                icon: "h-10 w-10"
            };
            
            return (
                <button
                    className={`${baseClasses} ${variants[variant]} ${sizes[size]} ${className}`}
                    onClick={onClick}
                    disabled={disabled}
                >
                    {children}
                </button>
            );
        };

        // Card Components
        const Card = ({ children, className = "" }) => (
            <div className={`rounded-lg border bg-card text-card-foreground shadow-sm border-slate-200 bg-white ${className}`}>
                {children}
            </div>
        );

        const CardContent = ({ children, className = "" }) => (
            <div className={`p-6 pt-0 ${className}`}>
                {children}
            </div>
        );

        // Main App Component
        const App = () => {
            const [isRecording, setIsRecording] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [transcript, setTranscript] = useState('');
            const [error, setError] = useState('');
            const mediaRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);

            const startRecording = async () => {
                try {
                    console.log("Starting recording...")
                    setError('');
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log("Microphone access granted")
                    
                    mediaRecorderRef.current = new MediaRecorder(stream);
                    audioChunksRef.current = [];
                    
                    mediaRecorderRef.current.ondataavailable = (event) => {
                      console.log("Audio data chunk received, size:", event.data.size)
                      audioChunksRef.current.push(event.data);
                    };
                    
                    mediaRecorderRef.current.onstop = async () => {
                      console.log("Recording stopped, processing audio...")
                      const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/wav' });
                      await processAudio(audioBlob);
                      stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorderRef.current.start();
                    setIsRecording(true);
                    console.log("Recording started successfully")
                } catch (err) {
                    console.error("Recording error:", err)
                    setError('Failed to access microphone: ' + err.message);
                }
            };

            const stopRecording = () => {
                if (mediaRecorderRef.current && isRecording) {
                    mediaRecorderRef.current.stop();
                    setIsRecording(false);
                    setIsProcessing(true);
                }
            };

            const processAudio = async (audioBlob) => {
              try {
                console.log("Processing audio blob, size:", audioBlob.size)
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.wav');
                formData.append('model', 'whisper-1');

                // Get API key from window object (passed from main process)
                const apiKey = window.OPENAI_API_KEY;
                if (!apiKey) {
                  setError('OpenAI API key not found. Please check your .env file.');
                  setIsProcessing(false);
                  return;
                }

                console.log("Sending request to OpenAI Whisper API...")
                const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${apiKey}`
                  },
                  body: formData
                });

                console.log("Response status:", response.status)
                if (!response.ok) {
                  const errorText = await response.text()
                  console.error("API Error:", errorText)
                  throw new Error(`Failed to transcribe audio: ${response.status} ${errorText}`)
                }

                const result = await response.json();
                console.log("Transcription result:", result)
                const text = result.text.trim();
                
                if (text) {
                  setTranscript(text);
                  console.log("Transcribed text:", text)
                  // Automatically paste the text
                  await ipcRenderer.invoke('paste-text', text);
                } else {
                  console.log("No text transcribed")
                }
              } catch (err) {
                console.error("Transcription error:", err)
                setError('Transcription failed: ' + err.message);
              } finally {
                setIsProcessing(false);
              }
            };

            const handleClose = () => {
                ipcRenderer.invoke('hide-window');
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Escape') {
                    handleClose();
                } else if (e.key === ' ' && !isRecording && !isProcessing) {
                    e.preventDefault();
                    startRecording();
                } else if (e.key === ' ' && isRecording) {
                    e.preventDefault();
                    stopRecording();
                }
            };

            useEffect(() => {
                document.addEventListener('keydown', handleKeyPress);
                return () => document.removeEventListener('keydown', handleKeyPress);
            }, [isRecording, isProcessing]);

            return (
                <div className="p-4">
                    <Card className="glass-effect border-white/20 bg-white/10 backdrop-blur-xl">
                        <CardContent className="p-6">
                            <div className="flex flex-col items-center space-y-4">
                                <div className="flex items-center justify-between w-full">
                                    <h2 className="text-lg font-semibold text-white">Whisper Dictation</h2>
                                    <Button
                                        variant="ghost"
                                        size="sm"
                                        onClick={handleClose}
                                        className="text-white hover:bg-white/20"
                                    >
                                        ‚úï
                                    </Button>
                                </div>
                                
                                <div className="flex flex-col items-center space-y-3">
                                    {isProcessing ? (
                                        <div className="flex flex-col items-center space-y-2">
                                            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
                                            <p className="text-sm text-white/80">Processing...</p>
                                        </div>
                                    ) : (
                                        <Button
                                            onClick={isRecording ? stopRecording : startRecording}
                                            className={`w-16 h-16 rounded-full ${
                                                isRecording 
                                                    ? 'bg-red-500 hover:bg-red-600 animate-pulse' 
                                                    : 'bg-blue-500 hover:bg-blue-600'
                                            }`}
                                            disabled={isProcessing}
                                        >
                                            {isRecording ? '‚èπÔ∏è' : 'üé§'}
                                        </Button>
                                    )}
                                    
                                    <p className="text-xs text-white/70 text-center">
                                        {isRecording 
                                            ? 'Recording... Press space or click to stop' 
                                            : 'Press space or click to start recording'
                                        }
                                    </p>
                                </div>

                                {transcript && (
                                    <div className="w-full p-3 bg-white/20 rounded-md">
                                        <p className="text-sm text-white">{transcript}</p>
                                    </div>
                                )}

                                {error && (
                                    <div className="w-full p-3 bg-red-500/20 rounded-md">
                                        <p className="text-sm text-red-200">{error}</p>
                                    </div>
                                )}

                                <p className="text-xs text-white/50 text-center">
                                    Press Fn key or Cmd+` to toggle ‚Ä¢ ESC to close
                                </p>
                            </div>
                        </CardContent>
                    </Card>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
